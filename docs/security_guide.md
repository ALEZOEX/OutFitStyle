# Безопасность и аутентификация в OutfitStyle V2

## 1. JWT-аутентификация

### 1.1. Архитектура токенов
- Access токены: короткий срок (24 часа)
- Refresh токены: длительный срок (7 дней)
- Токены подписываются с использованием безопасного секрета

### 1.2. Сценарии аутентификации
- `/api/v1/auth/login` - получение пары токенов
- `/api/v1/auth/refresh` - обновление access токена с помощью refresh токена
- Все защищенные endpoints проверяют JWT токен в заголовке Authorization

## 2. Авторизация

### 2.1. Проверка владельца ресурса
Все endpoints, которые работают с пользовательскими данными:
- Проверяют user_id в URL параметрах
- Сравнивают с user_id из JWT токена
- Возвращают 403 Forbidden если не совпадают

Пример:
```
// Вместо:
GET /api/v1/users/123/profile  // Любой может получить чужой профиль

// Используется:
GET /api/v1/users/{own_id}/profile  // Только владелец может получить свой профиль
```

### 2.2. Middleware проверки авторизации
Каждый защищенный ресурс использует middleware:
- Извлекает JWT токен из заголовка Authorization
- Декодирует и проверяет подпись
- Извлекает user_id из токена
- Сравнивает с запрашиваемым ресурсом
- Возвращает ошибку если пользователь пытается получить доступ к чужим данным

## 3. Rate Limiting

### 3.1. Защита от DDoS
- Ограничения по IP: 1000 запросов в час
- Ограничения по user_id: 500 запросов в час
- Отдельные ограничения для /recommendations: 50 запросов в минуту

### 3.2. Redis-based хранилище
- Все лимиты хранятся в Redis с TTL
- Используется sliding window алгоритм
- Middleware проверяет лимиты перед обработкой запроса

## 4. Валидация параметров

### 4.1. Проверка идентификаторов
- Все ID параметры проверяются на валидность (целочисленные > 0)
- UUID параметры проверяются на корректный формат
- Возвращается 400 Bad Request при невалидных параметрах

### 4.2. Санитизация данных
- Входные данные проходят валидацию через JSON схемы
- SQL-инъекции предотвращаются через подготовленные выражения
- XSS предотвращается через экранирование вывода

## 5. Права доступа к данным

### 5.1. Гардероб пользователя
- Пользователь может просматривать/редактировать только свои вещи
- При добавлении вещи в гардероб: `user_id` автоматически заполняется из токена
- Неавторизованные запроски возвращают 401 Unauthorized

### 5.2. Рекомендации
- Пользователь может получить только свои рекомендации
- История рекомендаций хранится с привязкой к user_id
- Оценки рекомендаций сохраняются с привязкой к user_id
- При сохранении оценки проверяется, что рекомендация принадлежит пользователю (security check в репозитории)
- Избранные также привязаны к владельцу

## 6. Логирование безопасности

### 6.1. Подозрительная активность
- Логируются попытки доступа к чужим данным
- Логируются частые запросы с одного IP
- Логируются попытки доступа без токена к защищенным endpoints

### 6.2. Аудит действий
- Все операции изменения данных логируются с user_id
- Временные метки для трассировки действий
- Отделение логов безопасности от обычных логов

## 7. Защита от утечек данных

### 7.1. Права доступа к БД
- Приложение подключается к БД с ограниченными правами
- Нет прав на административные операции
- Используются подготовленные выражения для всех запросов

### 7.2. Защита конфиденциальных данных
- Пароли хешируются с солью
- Персональные данные шифруются при хранении
- Логи не содержат конфиденциальных данных (токенов, паролей и т.д.)