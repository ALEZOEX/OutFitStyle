# Профессиональная архитектура OutfitStyle

## Обзор

OutfitStyle реализует продвинутую архитектуру с единой моделью вещей и системой Retrieval + Ranking для подбора рекомендаций. 

## Продовый подход: единая модель вещей → Retrieval → Ranking

### Цели архитектуры
- Единый каталог вещей в Postgres с различными источниками:
  - Реальные вещи гардероба пользователя
  - Вещи из интернет-каталога/парсинга
  - "Образцовые" Kaggle-вещи
- Приоритеты источников:
  - Личный гардероб (если по погоде подходит)
  - Реальные новые вещи (catalog/marketplace)
  - Kaggle seed как "учебный магазин"
- Retrieval (подбор кандидатов): быстрый SQL/правила по погоде, полу, стилю, сезону и источнику
- Ranking (ML-модель): ранжирует и комбинирует уже малое число кандидатов (до 500–1000, а не 44k)
- Никаких таймаутов/404 от ML, никакого "ручного затыкания дыр"

## Структура БД

### clothing_items
Расширенная таблица с атрибутами:
- `gender`, `master_category`, `subcategory`, `season`, `base_colour`, `usage`
- `source` ('wardrobe', 'catalog', 'kaggle_seed', ...)
- `is_owned`, `owner_user_id`
- `min_temp`, `max_temp`, `warmth_level`, `formality_level`

### wardrobe_items
Связь между пользователями и их личными вещами:
- `user_id`, `clothing_item_id`
- Это позволяет быстро получать пользовательские вещи

## ML-ранжирование: приоритет источников

### В фичах модели
- One-hot/label-encoding для `source` (wardrobe, catalog, kaggle_seed)
- Бинарный признак `is_owned`
- При финальном скоринге:
  - +α к score, если `is_owned = True` и вещь подходит по погоде (личные вещи)
  - Немного меньший приоритет для catalog по сравнению с wardrobe
  - Kaggle_seed — базовая линия (0)

## Go-бэкенд: упрощённый ML-клиент

- ML-сервис теперь всегда работает через `clothing_items`, никаких CSV/404/таймаутов на 40 секунд
- Убраны почти все костыли в `RecommendationService.GetRecommendations`
- Теперь все рекомендации сохраняются в БД, так как все вещи из базы данных
- При `source='kaggle_seed'` в ответе ML-сервиса — рекомендации не сохраняются в БД (как и сейчас)
- Когда Kaggle-вещи будут в `clothing_items` с нормальными ID и FK — проверки можно убирать

## Flutter: нормальное разделение источников

### Модель ClothingItem
Обновлена для парсинга всех новых полей:
```dart
class ClothingItem {
  final int id;
  final String name;
  final String category;
  final String? subcategory;
  final String source;   // 'wardrobe', 'catalog', 'kaggle_seed'
  final bool isOwned;
  final double? minTemp;
  final double? maxTemp;
  final int? warmthLevel;
  final int? formalityLevel;
  // ...
}
```

### Визуальное разделение в UI
- "Что из твоего гардероба" (isOwned == true) — отмечено специальной иконкой
- "Что стоит докупить" (isOwned == false и source != 'kaggle_seed') — с пометкой
- "Образцовые варианты" (source == 'kaggle_seed') — отображаются как идея

### Пустой список
Если `items.isEmpty` → показываем "Нет подходящих вещей, добавь одежду в гардероб" вместо стека ошибок.

## Преимущества подхода

1. **Профессиональный**: 
   - Единая схема
   - Чёткое разделение Retrieval/Ranking
   - Предсказуемые таймауты
   - Приоритеты источников

2. **Гибкий**:
   - Можно добавлять реальные вещи, парсеры
   - Менять веса без ломки архитектуры

3. **Учитывает сценарии**:
   - Бедный/непосезонный гардероб
   - Комбинирование Wardrobe + Catalog + Kaggle
   - Сохранение разнообразия и "крутости" рекомендаций за счёт десятков тысяч seed-вещей

## ЭТАП 4: ML-ранжирование с учетом источников

### Обновления в ML-модели

В `EnhancedOutfitPredictor` и `features.py` добавлены новые признаки:
- `is_wardrobe` - one-hot признак для вещей из гардероба
- `is_catalog` - one-hot признак для вещей из каталога
- `is_kaggle_seed` - one-hot признак для образцовых вещей
- `is_owned` - бинарный признак принадлежности пользователю

### Приоритеты в ранжировании

В финальном скоринге реализована следующая логика:
- Вещи из гардероба (wardrobe) получают +α к score при подходящих погодных условиях
- Вещи из каталога (catalog) имеют средний приоритет
- Образцовые вещи (kaggle_seed) служат базовой линией (0)

## ЭТАП 5: Go-бэкенд с упрощенным ML-клиентом

### Упрощения в ML-сервисе

- ML-сервис теперь всегда работает через `clothing_items` в БД
- Убраны все проблемы с CSV/404/таймаутами
- Прекращено использование `load_internal_dataset_items()`
- Возвращено поле `source` для правильной идентификации источника вещей

### Улучшения в RecommendationService

- Убраны почти все костыли из `GetRecommendations`
- При наличии `source='kaggle_seed'` в ответе ML-сервиса - рекомендации не сохраняются в БД
- Когда Kaggle-вещи находятся в `clothing_items` с нормальными ID и FK - проверки можно убирать

## ЭТАП 6: Flutter с улучшенной обработкой источников

### Обновленная модель ClothingItem

Теперь модель `ClothingItem` в Dart корректно обрабатывает поля:
- `source` - источник ('wardrobe', 'catalog', 'kaggle_seed')
- `is_owned` - принадлежит ли пользователю

### Визуальное разделение источников

В интерфейсе реализовано визуальное разделение:
- "Что есть в гардеробе" (isOwned == true) - зеленая метка
- "Что можно докупить" (isOwned == false и source != 'kaggle_seed') - синяя метка
- "Образцовые варианты" (source == 'kaggle_seed') - оранжевая метка

### Обработка пустых списков

При отсутствии вещей:
- Показывается понятное сообщение "нет вещей, добавь одежду в гардероб"
- Нет пустых списов или ошибок отображения
- Сохраняется стабильность интерфейса

## Результаты

Такой подход создает:

- **Профессиональную архитектуру** с единым каталогом и четким разделением Retrieval/Ranking
- **Гибкую систему**, позволяющую легко добавлять новые источники данных
- **Учет ваших сценариев** использования:
  - Пустой/не по сезону гардероб → комплект формируется из каталога/Kaggle
  - Богатый гардероб → приоритет своим вещам
  - Комбинация источников → гармоничное сочетание разных подходов
  - Сохранение разности и "крутости" рекомендаций за счет тысяч образцовых вещей